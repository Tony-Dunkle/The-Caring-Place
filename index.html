<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Caring Place Bingo</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Deep charcoal background */
            color: #e2e8f0; /* Light gray text for contrast */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            position: relative;
            font-size: 0.95rem; /* Slightly smaller base font size */
        }
        .container {
            background-color: #2d3748; /* Darker gray background for the main container */
            border-radius: 1.5rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4); /* Deeper shadow */
            padding: 2.5rem;
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
        }
        /* Header specific styles for the new layout */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 1rem; /* Adjusted margin to bring closer to number display */
        }
        .header-title-left {
            color: #c084fc; /* Tailwind Purple-400 for header text */
            font-size: 2.8rem; /* Slightly smaller */
            font-weight: bold;
            text-shadow: 0 0 10px rgba(192, 132, 252, 0.4); /* Subtle glow */
            flex-shrink: 1; /* Allow shrinking if space is tight */
            text-align: left; /* Align to left */
        }
        .header-bingo-center {
            color: #c084fc;
            font-size: 3.8rem; /* Slightly smaller */
            font-weight: bold;
            text-shadow: 0 0 15px rgba(192, 132, 252, 0.5);
            flex-grow: 1; /* Allow it to take available space */
            text-align: center; /* Center align */
            white-space: nowrap; /* Prevent "Bingo" from wrapping */
            min-width: fit-content; /* Ensure it doesn't get too small */
            padding: 0 1rem; /* Add some padding around "Bingo" */
        }
        /* New wrapper for logo and stats */
        .logo-stats-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center items horizontally within this column */
            gap: 0.5rem; /* Space between logo and stats, and between stats */
            flex-shrink: 0; /* Prevent shrinking */
        }
        .logo-container {
            width: 300px; /* Desired smaller image width */
            height: 133px; /* Desired smaller image height (maintaining aspect ratio) */
            border-radius: 0.75rem;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
            overflow: hidden; /* Ensure image doesn't spill out if larger */
        }
        .logo-container img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Contain the image within the dimensions */
            background-color: #4a5568; /* Placeholder background if image fails to load */
        }
        @media (max-width: 900px) { /* Adjust for smaller screens where the image might be too big */
            .logo-container {
                width: 100%; /* Make it fluid on smaller screens */
                height: 100px; /* Adjust height for fluid width */
            }
            .app-header {
                flex-wrap: wrap; /* Allow wrapping on smaller screens */
                justify-content: center;
                gap: 1rem; /* Space between wrapped items */
            }
            .header-title-left,
            .header-bingo-center {
                flex-basis: 100%; /* Take full width when wrapped */
                text-align: center; /* Center align all elements when wrapped */
            }
            .header-title-left {
                font-size: 2.3rem; /* Adjusted for smaller screens */
            }
            .header-bingo-center {
                font-size: 3.2rem; /* Adjusted for smaller screens */
            }
        }

        .number-display {
            background-color: #7c3aed; /* Tailwind Purple-600 for current number */
            color: #ffffff;
            font-size: 7.5rem; /* Tiny bit smaller */
            font-weight: bold;
            padding: 2rem 3rem;
            border-radius: 1rem;
            min-width: 250px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s ease-out;
            display: flex;
            justify-content: center;
            align-items: center;
            line-height: 1;
            margin-top: 0; /* Remove top margin as it's now directly below header */
            margin-bottom: 2rem; /* Add margin below to separate from next section */
        }
        .number-display.pop {
            transform: scale(1.1);
        }
        .control-button {
            background-color: #9333ea; /* Tailwind Purple-700 */
            color: white;
            padding: 1.1rem 2.2rem; /* Slightly smaller padding */
            font-size: 1.6rem; /* Slightly smaller */
            font-weight: bold;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .control-button:hover {
            background-color: #7e22ce; /* Darker purple on hover */
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }
        .control-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .reset-button {
            background-color: #dc2626; /* Tailwind Red-600 for reset button */
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 100;
        }
        .reset-button:hover {
            background-color: #b91c1c; /* Darker red on hover */
        }
        /* New styles for the columnar called numbers grid */
        .called-numbers-columns {
            display: flex;
            justify-content: space-around; /* Distribute columns evenly */
            gap: 0.75rem;
            max-height: 650px; /* Maintained height for overall section */
            overflow-y: auto; /* Still allow scrolling if too many numbers */
            padding: 1rem;
            background-color: #4a5568;
            border-radius: 0.75rem;
            border: 1px solid #4a5568;
            width: 100%; /* Ensure it takes full width */
        }
        .called-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid #3d4657; /* Slightly lighter border for inner columns */
            border-radius: 0.5rem;
            min-width: 65px; /* Minimum width for each column to prevent squishing */
        }
        .called-column-header {
            font-size: 1.7rem; /* Slightly smaller */
            font-weight: bold;
            color: #c084fc;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 8px rgba(192, 132, 252, 0.3);
        }
        .called-number-item {
            background-color: #6b46c1; /* Tailwind Purple-700 for individual numbers */
            color: #e2e8f0; /* Light text on dark background */
            font-size: 1.5rem; /* Slightly smaller */
            font-weight: bold;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: 0 3px 7px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            white-space: nowrap; /* Ensure content stays on one line */
            margin-bottom: 0.5rem; /* Space between numbers in a column */
            cursor: pointer; /* Added for unselection */
        }
        .error-message { /* Keeping this just in case for future use, though not used currently */
            color: #f87171; /* Tailwind Red-400 for error messages */
            font-size: 1.05rem; /* Slightly smaller */
            margin-top: 0.5rem;
            text-align: center;
            min-height: 24px;
        }
        .rules-section {
            background-color: #4a5568; /* Darker background for rules */
            border: 1px solid #718096; /* Darker border */
            border-radius: 1rem;
            padding: 2rem;
            font-size: 1.1rem; /* Slightly smaller */
            line-height: 1.6;
            color: #e2e8f0; /* Light text for rules */
        }
        .rules-section h3 {
            font-size: 1.9rem; /* Slightly smaller */
            font-weight: bold;
            color: #c084fc; /* Purple heading for rules */
            margin-bottom: 1rem;
            text-align: center;
        }
        .rules-section ul {
            list-style: disc;
            padding-left: 1.5rem;
        }
        .rules-section li {
            margin-bottom: 0.5rem;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Above all other content */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #4a5568; /* Changed to match all-number-item background */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); /* Stronger shadow */
            max-width: 90%;
            max-height: 90vh; /* Max height to prevent overflow on smaller screens */
            overflow-y: auto; /* Enable scrolling for modal content */
            position: relative;
            color: #e2e8f0; /* Light text for modal */
            border: 1px solid #6b46c1; /* Added a subtle purple border */
            display: flex; /* Make it a flex container */
            flex-direction: column; /* Stack children vertically */
            align-items: center; /* Center horizontally */
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.8rem; /* Slightly smaller */
            color: #a0aec0; /* Gray for close button */
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .modal-close-button:hover {
            color: #cbd5e0; /* Lighter gray on hover */
        }
        .modal-top-controls {
            width: 100%;
            display: flex;
            justify-content: flex-end; /* Align to the right for now */
            margin-bottom: 1.5rem;
            gap: 1rem; /* Space between buttons */
            padding-right: 2.5rem; /* Account for close button position */
        }
        /* All numbers grid and column layout */
        .all-numbers-grid-container {
            display: flex;
            flex-direction: row; /* Layout columns horizontally */
            justify-content: center;
            gap: 1rem; /* Space between columns */
            flex-wrap: wrap; /* Allow columns to wrap on smaller screens */
            width: 100%; /* Ensure it takes full width of modal content */
        }
        .bingo-column {
            display: flex;
            flex-direction: column; /* Stack numbers vertically within a column */
            gap: 0.25rem; /* Small gap between numbers in a column */
            min-width: 75px; /* Minimum width for each column */
            border: 1px solid #4a5568; /* Subtle border for columns */
            border-radius: 0.5rem;
            padding: 0.5rem;
            align-items: center; /* Center numbers within column */
            flex-grow: 1; /* Allow columns to grow */
            flex-basis: auto; /* Allow content to determine basis */
        }
        .bingo-column-header {
            font-size: 1.7rem; /* Slightly smaller */
            font-weight: bold;
            color: #c084fc; /* Purple for column headers */
            margin-bottom: 0.5rem;
            text-shadow: 0 0 8px rgba(192, 132, 252, 0.3);
        }
        .all-number-item {
            background-color: #4a5568; /* Darker background for each number item */
            color: #e2e8f0; /* Light text */
            font-size: 1.1rem; /* Slightly smaller */
            font-weight: bold;
            padding: 0.6rem;
            border-radius: 0.3rem;
            text-align: center;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease, color 0.2s ease;
            width: 100%; /* Make items take full column width */
            cursor: pointer; /* Indicate clickability */
        }
        .all-number-item:hover:not(.called) {
            background-color: #6b46c1; /* Darker purple on hover for uncalled numbers */
        }
        .all-number-item.called {
            background-color: #9333ea; /* Purple for called numbers */
            color: white;
            box-shadow: 0 0 5px rgba(192, 132, 252, 0.7); /* Subtle glow for called numbers */
            cursor: pointer; /* Changed to pointer to allow unselection */
            /* opacity: 0.6; -- Removed to make them appear more selectable */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
                font-size: 0.9rem; /* Further smaller base font size on mobile */
            }
            .container {
                padding: 1.5rem;
                gap: 1.5rem;
            }
            .app-header {
                flex-direction: column; /* Stack header elements on small screens */
                align-items: center;
                gap: 1.5rem;
                margin-bottom: 1.5rem;
            }
            .header-title-left {
                font-size: 2rem; /* Adjusted for smaller screens */
                text-align: center;
            }
            .header-bingo-center {
                font-size: 2.8rem; /* Adjusted for smaller screens */
                padding: 0;
            }
            .logo-container {
                width: 100%;
                height: 80px; /* Adjusted height for smaller fluid width */
            }
            .logo-container img {
                font-size: 0.75rem; /* Make alt text smaller on mobile */
            }
            .number-display {
                font-size: 3.8rem; /* Adjusted for mobile, tiny bit smaller */
                padding: 1rem 1.5rem;
                min-width: unset;
                width: 100%;
                margin-bottom: 1.5rem; /* Adjusted margin for mobile */
            }
            .control-button {
                font-size: 1.3rem; /* Adjusted for mobile */
                padding: 0.7rem 1.6rem; /* Adjusted for mobile */
            }
            .called-numbers-columns {
                flex-direction: column; /* Stack columns vertically on mobile */
                max-height: 350px; /* Adjusted height for mobile */
            }
            .called-column {
                width: 80%; /* Give columns more width when stacked */
                max-width: 150px; /* Limit max width for a single column */
                flex-basis: auto;
                margin-bottom: 0.75rem; /* Add space between stacked columns */
            }
            .called-column-header {
                font-size: 1.4rem; /* Adjusted for mobile */
            }
            .called-number-item {
                font-size: 1.1rem; /* Adjusted for mobile */
            }
            .rules-section {
                font-size: 0.95rem; /* Adjusted for mobile */
                padding: 1.5rem;
            }
            .rules-section h3 {
                font-size: 1.6rem; /* Adjusted for mobile */
            }
            .reset-button {
                bottom: 1rem;
                right: 1rem;
                padding: 0.7rem 1.4rem; /* Adjusted for mobile */
                font-size: 1.3rem; /* Adjusted for mobile */
            }
            .modal-content {
                padding: 1rem;
            }
            .modal-close-button {
                font-size: 1.4rem; /* Adjusted for mobile */
                top: 0.5rem;
                right: 0.5rem;
            }
            .modal-top-controls {
                justify-content: center; /* Center buttons on mobile */
                padding-right: 0;
            }
            .all-numbers-grid-container {
                flex-direction: column;
                align-items: center;
            }
            .bingo-column {
                width: 80%;
                max-width: 150px;
                flex-basis: auto;
            }
            .bingo-column-header {
                font-size: 1.4rem; /* Adjusted for mobile */
            }
            .all-number-item {
                font-size: 0.95rem; /* Adjusted for mobile */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="app-header">
            <h1 class="header-title-left">The Caring Place</h1>
            <h1 class="header-bingo-center">Bingo</h1>
            <!-- New: Wrapper for Logo and Stats -->
            <div class="logo-stats-wrapper">
                <div class="logo-container">
                    <img src="Caring Place logo.png" alt="The Caring Place Logo" onerror="this.onerror=null;this.src='https://placehold.co/300x133/4a5568/a0aec0?text=Logo+Unavailable';">
                </div>
                <!-- Numbers Called Count -->
                <div id="calledNumbersCountDisplay" class="bg-gray-700 text-purple-300 rounded-lg px-4 py-2 text-center text-lg font-bold shadow-md">
                    Numbers Called: 0
                </div>
                <!-- Bingo Estimate Display -->
                <div id="bingoEstimateDisplay" class="bg-gray-700 text-purple-300 rounded-lg px-4 py-2 text-center text-md shadow-md">
                    Bingo Estimation: ---
                </div>
            </div>
        </div>

        <!-- Current Number Display -->
        <div class="w-full flex justify-start">
            <div id="currentNumberDisplay" class="number-display">
                --
            </div>
        </div>

        <!-- Called Numbers Section -->
        <div class="w-full">
            <h2 class="text-3xl font-bold text-gray-200 mb-4 text-center">Called Numbers</h2>
            <div id="calledNumbersGrid" class="called-numbers-columns">
                <!-- Columns for B, I, N, G, O will be dynamically added here by JavaScript -->
            </div>
        </div>

        <!-- Controls -->
        <div class="flex flex-col items-center w-full gap-4 mt-4">
            <button id="showAllNumbersBtn" class="control-button">Select Number</button>
            <!-- Game Type Selection Section -->
            <div class="game-type-section w-full mb-4 text-center">
                <label for="gameTypeSelect" class="text-xl font-bold text-gray-200 block mb-2">Select Game Type:</label>
                <select id="gameTypeSelect" class="bg-gray-700 text-purple-300 border border-purple-500 rounded-md p-2 text-lg focus:outline-none focus:ring-2 focus:ring-purple-400">
                    <option value="standard">Standard Bingo (5 in a row)</option>
                    <option value="four-corners">Four Corners</option>
                    <option value="blackout">Blackout / Coverall</option>
                    <option value="custom">Custom Pattern (Explain to players)</option>
                </select>
                <p class="text-2xl font-bold text-purple-300 mt-4">Current Game: <span id="currentGameTypeDisplay">Standard Bingo (5 in a row)</span></p>
            </div>
        </div>

        <!-- Bingo Rules Section -->
        <div class="rules-section w-full mt-8">
            <h3>Bingo Rules</h3>
            <ul>
                <li>Standard Bingo: The first player to get 5 numbers in a row, either horizontally, vertically, or diagonally, wins!</li>
                <li>Four Corners: Cover the numbers in all four corner squares of your card.</li>
                <li>Blackout/Coverall: Cover every single number on your bingo card. This is usually the last game!</li>
                <li>Pattern Games: Some games might require specific patterns (e.g., a "T" shape, a "postage stamp"). Listen carefully for the pattern!</li>
                <li>Calling Bingo: When you get a winning pattern, shout "BINGO!" loudly and clearly so the caller can hear you.</li>
                <li>Verification: The caller will verify your card against the called numbers. If it's correct, you win!</li>
                <li>Enjoy the Game: Most importantly, have fun and enjoy playing with your friends!</li>
            </ul>
        </div>

        <!-- Import/Export Buttons -->
        <div class="flex flex-col sm:flex-row items-center justify-center w-full gap-4 mt-6">
            <button id="exportGameDataBtn" class="control-button text-sm px-4 py-2">Export Game Data</button>
            <button id="importGameDataBtn" class="control-button text-sm px-4 py-2">Import Game Data</button>
        </div>
    </div>

    <!-- Reset Game Button -->
    <button id="resetGameBtn" class="control-button reset-button">Reset Game</button>

    <!-- Modal for All Callable Numbers -->
    <div id="allNumbersModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" id="closeModalBtn">&times;</button>
            <h2 class="text-3xl font-bold text-center text-purple-400 mb-4">All Possible Bingo Numbers</h2>
            <div class="modal-top-controls">
                <button id="selectAllNumbersBtn" class="control-button text-sm px-4 py-2">Select All Uncalled</button>
            </div>
            <div id="allNumbersGridContainer" class="all-numbers-grid-container">
                <!-- Columns for B, I, N, G, O will be dynamically generated here -->
            </div>
        </div>
    </div>

    <!-- New: Import Data Modal -->
    <div id="importDataModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" id="closeImportModalBtn">&times;</button>
            <h2 class="text-3xl font-bold text-center text-purple-400 mb-4">Import Game Data</h2>
            <textarea id="importDataTextarea" class="w-full h-48 p-4 bg-gray-800 text-gray-200 border border-purple-500 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-400 text-sm" placeholder="Paste your exported game data here..."></textarea>
            <div class="flex justify-end w-full gap-4 mt-4">
                <button id="importDataConfirmBtn" class="control-button text-sm px-4 py-2">Import</button>
                <button id="importDataCancelBtn" class="control-button text-sm px-4 py-2 bg-gray-500 hover:bg-gray-600">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const currentNumberDisplay = document.getElementById('currentNumberDisplay');
        const resetGameBtn = document.getElementById('resetGameBtn');
        const calledNumbersGrid = document.getElementById('calledNumbersGrid'); // This is now the container for columns
        const showAllNumbersBtn = document.getElementById('showAllNumbersBtn');
        const allNumbersModal = document.getElementById('allNumbersModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const allNumbersGridContainer = document.getElementById('allNumbersGridContainer');
        const gameTypeSelect = document.getElementById('gameTypeSelect');
        const currentGameTypeDisplay = document.getElementById('currentGameTypeDisplay');
        const selectAllNumbersBtn = document.getElementById('selectAllNumbersBtn');
        const calledNumbersCountDisplay = document.getElementById('calledNumbersCountDisplay');
        const bingoEstimateDisplay = document.getElementById('bingoEstimateDisplay');

        // New Import/Export Elements
        const exportGameDataBtn = document.getElementById('exportGameDataBtn');
        const importGameDataBtn = document.getElementById('importGameDataBtn');
        const importDataModal = document.getElementById('importDataModal');
        const closeImportModalBtn = document.getElementById('closeImportModalBtn');
        const importDataTextarea = document.getElementById('importDataTextarea');
        const importDataConfirmBtn = document.getElementById('importDataConfirmBtn');
        const importDataCancelBtn = document.getElementById('importDataCancelBtn');


        // Game State Variables
        let calledCombinations = new Set();
        let calledNumbersDisplay = []; // This array holds all called combinations, sorted
        // A map to quickly access column elements
        const calledColumns = {}; // { 'B': element, 'I': element, ... }


        // Bingo Number Ranges for Validation
        const bingoRanges = {
            'B': { min: 1, max: 15 },
            'I': { min: 16, max: 30 },
            'N': { min: 31, max: 45 },
            'G': { min: 46, max: 60 },
            'O': { min: 61, max: 75 }
        };
        const bingoLetters = ['B', 'I', 'N', 'G', 'O'];

        /**
         * Updates the display of how many unique numbers have been called.
         */
        function updateNumbersCountDisplay() {
            calledNumbersCountDisplay.textContent = `Numbers Called: ${calledCombinations.size}`;
        }

        /**
         * Estimates the possibility of bingo based on game type and called numbers.
         */
        function updateBingoEstimate() {
            const currentSelectedGameType = gameTypeSelect.value;
            let estimateText = "Bingo Estimation: ";

            switch (currentSelectedGameType) {
                case 'standard':
                    const calledCount = calledCombinations.size;
                    if (calledCount < 10) {
                        estimateText += "Game just started, many bingos possible!";
                    } else if (calledCount >= 10 && calledCount <= 30) {
                        estimateText += "Players getting closer, bingos becoming likely.";
                    } else if (calledCount > 30 && calledCount < 75) {
                        estimateText += "Multiple bingos are very likely now!";
                    } else if (calledCount === 75) {
                        estimateText += "All numbers called - Blackout likely!";
                    }
                    break;
                case 'four-corners':
                    const cornerNumbers = ['B-1', 'B-15', 'O-61', 'O-75']; // Assuming standard card corners, this is a rough estimate
                    let cornersCalled = 0;
                    cornerNumbers.forEach(corner => {
                        if (calledCombinations.has(corner)) {
                            cornersCalled++;
                        }
                    });
                    if (cornersCalled === 4 && calledCombinations.size >= 4) { // Ensure at least 4 numbers called for 4 corners
                        estimateText += "Four corners hit! Bingo!";
                    } else {
                        estimateText += `Corners hit: ${cornersCalled}/4. Keep an eye out!`;
                    }
                    break;
                case 'blackout':
                    const percentComplete = ((calledCombinations.size / 75) * 100).toFixed(0);
                    if (calledCombinations.size === 75) {
                        estimateText = "Bingo Estimation: BLACKOUT ACHIEVED!";
                    } else {
                        estimateText += `${percentComplete}% complete. Almost there!`;
                    }
                    break;
                case 'custom':
                    estimateText += "Estimation not available for custom games.";
                    break;
                default:
                    estimateText += "Select a game type for estimation.";
            }
            bingoEstimateDisplay.textContent = estimateText;
        }
        
        /**
         * Updates the displayed text for the current game type.
         */
        function updateGameTypeDisplay() {
            currentGameTypeDisplay.textContent = gameTypeSelect.options[gameTypeSelect.selectedIndex].text;
        }

        /**
         * Initializes or resets the game state.
         * Clears all called numbers and resets displays.
         */
        function initializeGame() {
            calledCombinations.clear();
            calledNumbersDisplay = [];
            currentNumberDisplay.textContent = '--';
            
            // Clear and re-create column structure for called numbers
            calledNumbersGrid.innerHTML = ''; // Clear everything first
            for (const letter of bingoLetters) {
                const columnDiv = document.createElement('div');
                columnDiv.classList.add('called-column');
                columnDiv.id = `called-column-${letter}`; // Assign an ID for easy lookup

                const columnHeader = document.createElement('div');
                columnHeader.classList.add('called-column-header');
                columnHeader.textContent = letter;
                columnDiv.appendChild(columnHeader);

                calledNumbersGrid.appendChild(columnDiv);
                calledColumns[letter] = columnDiv; // Store reference to the column element
            }
            
            updateAllCallableNumbersDisplay(); // Update the modal's display
            
            // Reset game type display to default
            gameTypeSelect.value = 'standard';
            updateGameTypeDisplay();
            updateNumbersCountDisplay(); // Update new count display
            updateBingoEstimate(); // Update new estimate display
            console.log('Game initialized.');
        }

        /**
         * Toggles the called state of a bingo number.
         * If the number is called, it becomes uncalled. If uncalled, it becomes called.
         * @param {string} combination - The bingo combination (e.g., "B-7").
         */
        function toggleNumberCalledState(combination) {
            const isCalled = calledCombinations.has(combination);
            let lastDisplayUpdate = null;

            if (isCalled) {
                // Uncall the number
                calledCombinations.delete(combination);
                const index = calledNumbersDisplay.indexOf(combination);
                if (index > -1) {
                    calledNumbersDisplay.splice(index, 1);
                }
                console.log(`Uncalled: ${combination}. Total unique called: ${calledCombinations.size}`);
            } else {
                // Call the number
                calledCombinations.add(combination);
                calledNumbersDisplay.push(combination);
                lastDisplayUpdate = combination;
                console.log(`Called: ${combination}. Total unique called: ${calledCombinations.size}`);
            }

            // Always re-sort the display array to maintain order
            calledNumbersDisplay.sort((a, b) => {
                const letterOrder = bingoLetters.indexOf(a.charAt(0)) - bingoLetters.indexOf(b.charAt(0));
                if (letterOrder !== 0) return letterOrder;
                const numA = parseInt(a.substring(a.indexOf('-') + 1), 10);
                const numB = parseInt(b.substring(b.indexOf('-') + 1), 10);
                return numA - numB;
            });

            // Update current number display
            if (lastDisplayUpdate) {
                currentNumberDisplay.textContent = lastDisplayUpdate;
            } else if (calledNumbersDisplay.length > 0) {
                // If the removed number was the current display, set to the new last number or '--'
                if (!calledCombinations.has(currentNumberDisplay.textContent)) {
                    currentNumberDisplay.textContent = calledNumbersDisplay[calledNumbersDisplay.length - 1] || '--';
                }
            } else {
                currentNumberDisplay.textContent = '--';
            }
            currentNumberDisplay.classList.remove('pop');
            void currentNumberDisplay.offsetWidth; // Trigger reflow
            currentNumberDisplay.classList.add('pop');


            updateCalledNumbersDisplay(); // Refresh the main grid of called numbers
            updateAllCallableNumbersDisplay(); // Refresh the modal's display to reflect the change
            updateNumbersCountDisplay(); // Update new count display
            updateBingoEstimate(); // Update new estimate display
        }

        /**
         * Calls all currently uncalled numbers.
         */
        function selectAllUncalledNumbers() {
            let lastCalledCombination = '';
            const allPossibleNumbers = [];
            for (const letter in bingoRanges) {
                const range = bingoRanges[letter];
                for (let i = range.min; i <= range.max; i++) {
                    allPossibleNumbers.push(`${letter}-${i}`);
                }
            }

            allPossibleNumbers.forEach(combination => {
                if (!calledCombinations.has(combination)) {
                    // Directly add to set and display array for efficiency in this bulk operation
                    calledCombinations.add(combination);
                    calledNumbersDisplay.push(combination);
                    lastCalledCombination = combination; // Keep track of the last one added
                }
            });

            // Re-sort the entire list after adding many numbers
            calledNumbersDisplay.sort((a, b) => {
                const letterOrder = bingoLetters.indexOf(a.charAt(0)) - bingoLetters.indexOf(b.charAt(0));
                if (letterOrder !== 0) return letterOrder;
                const numA = parseInt(a.substring(a.indexOf('-') + 1), 10);
                const numB = parseInt(b.substring(b.indexOf('-') + 1), 10);
                return numA - numB;
            });

            // If any numbers were newly added, ensure current display updates to the last one added
            if (lastCalledCombination) { // Check if anything was actually selected
                currentNumberDisplay.textContent = lastCalledCombination;
                currentNumberDisplay.classList.remove('pop');
                void currentNumberDisplay.offsetWidth; // Trigger reflow
                currentNumberDisplay.classList.add('pop');
            } else if (calledNumbersDisplay.length === 0) {
                 // If no numbers were added and list is empty
                currentNumberDisplay.textContent = '--';
            }

            updateCalledNumbersDisplay();
            updateAllCallableNumbersDisplay(); // Refresh modal to show all numbers as called
            updateNumbersCountDisplay(); // Update new count display
            updateBingoEstimate(); // Update new estimate display

            console.log('All uncalled numbers selected.');
            allNumbersModal.classList.remove('show'); // Optionally close the modal
        }

        /**
         * Updates the display of all previously called numbers in the main grid (now columnar).
         */
        function updateCalledNumbersDisplay() {
            // Clear numbers from all columns first
            for (const letter of bingoLetters) {
                const column = calledColumns[letter];
                // Keep only the header element, remove all other children (numbers)
                while (column.children.length > 1) { // header is the first child
                    column.removeChild(column.lastChild);
                }
            }

            // Add numbers to their respective columns, maintaining numerical order
            const numbersByColumn = { 'B': [], 'I': [], 'N': [], 'G': [], 'O': [] };
            calledNumbersDisplay.forEach(combination => {
                const letter = combination.charAt(0);
                const number = parseInt(combination.substring(combination.indexOf('-') + 1), 10);
                numbersByColumn[letter].push({ combination, number });
            });

            for (const letter of bingoLetters) {
                numbersByColumn[letter].sort((a, b) => a.number - b.number); // Sort numerically
                const targetColumn = calledColumns[letter];
                if (targetColumn) {
                    numbersByColumn[letter].forEach(item => {
                        const numberDiv = document.createElement('div');
                        numberDiv.classList.add('called-number-item');
                        numberDiv.textContent = item.combination;
                        numberDiv.dataset.combination = item.combination; // Store combination for click listener
                        numberDiv.addEventListener('click', () => toggleNumberCalledState(item.combination)); // Add click listener
                        targetColumn.appendChild(numberDiv);
                    });
                }
            }
        }

        /**
         * Updates the display of all 75 callable bingo numbers in the modal, organized by letter.
         * Marks numbers that have already been called.
         */
        function updateAllCallableNumbersDisplay() {
            allNumbersGridContainer.innerHTML = '';

            bingoLetters.forEach(letter => {
                const columnDiv = document.createElement('div');
                columnDiv.classList.add('bingo-column');

                const columnHeader = document.createElement('div');
                columnHeader.classList.add('bingo-column-header');
                columnHeader.textContent = letter;
                columnDiv.appendChild(columnHeader);

                const range = bingoRanges[letter];
                for (let i = range.min; i <= range.max; i++) {
                    const combination = `${letter}-${i}`;
                    const numberDiv = document.createElement('div');
                    numberDiv.classList.add('all-number-item');
                    numberDiv.textContent = combination;
                    numberDiv.dataset.combination = combination;

                    if (calledCombinations.has(combination)) {
                        numberDiv.classList.add('called');
                    }
                    // Attach event listener to ALL items in the modal for toggling
                    numberDiv.addEventListener('click', () => toggleNumberCalledState(combination));
                    columnDiv.appendChild(numberDiv);
                }
                allNumbersGridContainer.appendChild(columnDiv);
            });
        }

        /**
         * Exports the current game data (called numbers) to the clipboard.
         */
        function exportGameData() {
            const dataToExport = {
                calledCombinations: Array.from(calledCombinations), // Convert Set to Array for JSON
                calledNumbersDisplay: calledNumbersDisplay // Already an array
            };
            const jsonData = JSON.stringify(dataToExport);

            // Use document.execCommand('copy') for clipboard operations in iframes
            const textarea = document.createElement('textarea');
            textarea.value = jsonData;
            textarea.style.position = 'fixed'; // Avoid scrolling to bottom
            textarea.style.left = '-9999px'; // Move out of screen
            document.body.appendChild(textarea);
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                const msg = successful ? 'Game data copied to clipboard!' : 'Failed to copy game data.';
                console.log(msg);
                // Optionally provide user feedback in UI
                alert(msg); // Using alert for simple feedback, can be replaced with custom modal
            } catch (err) {
                console.error('Oops, unable to copy', err);
                alert('Failed to copy game data. Please try manually copying from console if developer tools are open.');
            } finally {
                document.body.removeChild(textarea);
            }
        }

        /**
         * Opens the import data modal.
         */
        function showImportDataModal() {
            importDataTextarea.value = ''; // Clear previous data
            importDataModal.classList.add('show');
        }

        /**
         * Imports game data from the textarea.
         */
        function importGameData() {
            const rawData = importDataTextarea.value;
            if (!rawData) {
                alert("Please paste game data into the text area.");
                return;
            }

            try {
                const parsedData = JSON.parse(rawData);

                // Basic validation of imported data structure
                if (!parsedData || !Array.isArray(parsedData.calledCombinations) || !Array.isArray(parsedData.calledNumbersDisplay)) {
                    alert("Invalid data format. Please paste valid exported game data.");
                    return;
                }

                // Clear current game state
                calledCombinations.clear();
                calledNumbersDisplay = [];

                // Populate with imported data
                parsedData.calledCombinations.forEach(combo => calledCombinations.add(combo));
                parsedData.calledNumbersDisplay = parsedData.calledNumbersDisplay.filter(combo => calledCombinations.has(combo)); // Ensure consistency

                // Re-sort the imported calledNumbersDisplay to maintain correct order
                calledNumbersDisplay = parsedData.calledNumbersDisplay.sort((a, b) => {
                    const letterOrder = bingoLetters.indexOf(a.charAt(0)) - bingoLetters.indexOf(b.charAt(0));
                    if (letterOrder !== 0) return letterOrder;
                    const numA = parseInt(a.substring(a.indexOf('-') + 1), 10);
                    const numB = parseInt(b.substring(b.indexOf('-') + 1), 10);
                    return numA - numB;
                });

                // Update current number display based on imported data
                currentNumberDisplay.textContent = calledNumbersDisplay.length > 0 ? calledNumbersDisplay[calledNumbersDisplay.length - 1] : '--';
                currentNumberDisplay.classList.remove('pop');
                void currentNumberDisplay.offsetWidth; // Trigger reflow
                currentNumberDisplay.classList.add('pop');


                updateCalledNumbersDisplay();
                updateAllCallableNumbersDisplay();
                updateNumbersCountDisplay();
                updateBingoEstimate();

                alert("Game data imported successfully!");
                importDataModal.classList.remove('show'); // Close modal on success

            } catch (error) {
                console.error("Error importing data:", error);
                alert("Failed to import data. Please ensure the pasted text is valid JSON from a previous export.");
            }
        }


        // Event Listeners
        // Game Type Select Listener
        gameTypeSelect.addEventListener('change', updateGameTypeDisplay);
        gameTypeSelect.addEventListener('change', updateBingoEstimate);

        // Select All Button Listener
        selectAllNumbersBtn.addEventListener('click', selectAllUncalledNumbers);

        // Modal Event Listeners (for All Callable Numbers)
        showAllNumbersBtn.addEventListener('click', () => {
            updateAllCallableNumbersDisplay();
            allNumbersModal.classList.add('show');
        });

        closeModalBtn.addEventListener('click', () => {
            allNumbersModal.classList.remove('show');
        });

        allNumbersModal.addEventListener('click', (event) => {
            if (event.target === allNumbersModal) {
                allNumbersModal.classList.remove('show');
            }
        });

        // Import/Export Event Listeners (New)
        exportGameDataBtn.addEventListener('click', exportGameData);
        importGameDataBtn.addEventListener('click', showImportDataModal);
        importDataConfirmBtn.addEventListener('click', importGameData);
        closeImportModalBtn.addEventListener('click', () => importDataModal.classList.remove('show'));
        importDataCancelBtn.addEventListener('click', () => importDataModal.classList.remove('show'));
        importDataModal.addEventListener('click', (event) => {
            if (event.target === importDataModal) {
                importDataModal.classList.remove('show');
            }
        });


        // Event listener for the Reset Game button
        resetGameBtn.addEventListener('click', initializeGame);

        // Initialize the game when the entire page content has loaded
        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>
